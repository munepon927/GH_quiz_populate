<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grasshopper åŸºç¤ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ã‚¯ã‚¤ã‚º â€” v2 JSONå¯¾å¿œ</title>
<style>
  :root{--bg:#0b1020;--card:#12182b;--ink:#e9eef9;--muted:#a9b3c9;--accent:#4aa8ff;--accent-2:#82e0aa;--wrong:#ff6b6b}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:"Inter","Segoe UI",system-ui,-apple-system,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  header{padding:16px;border-bottom:1px solid #223;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);position:sticky;top:0}
  header h1{margin:0 0 6px;font-size:20px;font-weight:800}
  header .sub{color:var(--muted);font-size:12px}
  .wrap{max-width:1200px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media(max-width:1000px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #1b2238;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .quiz{padding:20px}
  .q-head{display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .pill{font-size:12px;color:var(--ink);background:#1a2240;border:1px solid #2a3560;padding:4px 10px;border-radius:999px}
  .q-title{font-size:20px;margin:8px 0}
  .q-img{width:100%;max-width:520px;border-radius:12px;border:1px solid #243054;background:#0f1530;padding:8px;margin:12px auto 0;display:none}
  .choices{display:grid;gap:10px;margin-top:10px}
  .choice{text-align:left;background:#0f1530;border:1px solid #223159;color:var(--ink);border-radius:12px;padding:14px;cursor:pointer;transition:transform .05s ease,border-color .2s ease}
  .choice:hover{transform:translateY(-1px);border-color:#335}
  .choice.correct{border-color:var(--accent-2);box-shadow:inset 0 0 0 1px var(--accent-2)}
  .choice.wrong{border-color:var(--wrong);box-shadow:inset 0 0 0 1px var(--wrong)}
  .explain{margin-top:12px;color:var(--muted);font-size:14px;line-height:1.6;white-space:pre-line}
  .controls{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#00122b;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.secondary{background:#1a2240;color:var(--ink);border:1px solid #2a3560}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .score{padding:16px}
  .score h3{margin:0 0 8px;font-size:16px}
  .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
  .kpi .box{background:#0f1530;border:1px solid #1e2b4d;padding:12px;border-radius:12px}
  .kpi .big{font-size:28px;font-weight:800}
  .bar{width:100%;height:8px;border-radius:999px;background:#101831;overflow:hidden;border:1px solid #1f2a4b}
  .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent) 0%,var(--accent-2) 100%);transition:width .5s ease}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #1d2744;text-align:left}
  th{color:var(--muted);font-weight:600}
  .mini-pill{font-size:11px;color:#0b1020;background:var(--accent-2);padding:2px 8px;border-radius:999px}
  .apps{margin-top:14px;background:#0f1530;border:1px dashed #294;border-radius:12px;padding:12px}
  .apps h4{margin:0 0 6px;font-size:14px}
  .apps-list{display:grid;gap:12px}
  .apps-item{display:flex;flex-direction:column;align-items:center;gap:10px}
  .apps-item img{width:100%;max-width:720px;border:1px solid #223159;border-radius:12px}
  .apps-item p{margin:0;color:var(--muted);font-size:14px;text-align:center;max-width:720px}
</style>
</head>
<body>
<header>
  <h1>ğŸ§© Grasshopper åŸºç¤ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ã‚¯ã‚¤ã‚º â€” v2 JSONå¯¾å¿œ</h1>
  <div class="sub">å›ç­”å¾Œã«å•é¡Œç”»åƒã‚’è¡¨ç¤ºï¼é¸æŠè‚¢ã¯æ¯å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼æˆç¸¾è¨˜éŒ²ã¤ã</div>
</header>
<div class="wrap">
  <section id="quizCard" class="card quiz" aria-live="polite">
    <div class="q-head">
      <span class="pill" id="progressPill">Q â€” / â€”</span>
      <span class="pill" id="topicPill">â€”</span>
      <span class="pill" id="diffPill">Lv â€”</span>
    </div>

    <h2 id="qTitle" class="q-title">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
    <div id="choices" class="choices"></div>
    <div id="explain" class="explain"></div>
    <img id="qImg" class="q-img" alt="Component image" src="" onerror="this.style.display='none';" />

    <div id="apps" class="apps" style="display:none">
      <h4>ğŸ’¡ ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½¿ã„ã©ã“ã‚</h4>
      <div id="appsList" class="apps-list"></div>
    </div>

    <div class="controls">
      <button id="nextBtn" class="btn" disabled>æ¬¡ã®å•é¡Œã¸</button>
      <button id="skipBtn" class="btn secondary">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </section>

  <aside class="card score">
    <h3>ğŸ“Š æˆç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h3>
    <div class="kpi">
      <div class="box">
        <div>ä»Šå›ã®æ­£è§£ç‡</div>
        <div id="sessionAcc" class="big">â€”</div>
        <div class="bar"><div id="sessionBar"></div></div>
      </div>
      <div class="box">
        <div>ç´¯ç©ã®æ­£è§£ç‡</div>
        <div id="globalAcc" class="big">â€”</div>
        <div class="bar"><div id="globalBar"></div></div>
      </div>
    </div>
    <table id="perItem"><thead><tr><th>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</th><th>æ­£è§£/è©¦è¡Œ</th><th>ç‡</th></tr></thead><tbody></tbody></table>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button id="resetSession" class="btn secondary">ä»Šå›ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="resetGlobal" class="btn secondary">ç´¯ç©ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </aside>
</div>

<script>
/************** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ **************/
const shuffle=(a)=>{const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b};
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const pctTxt=(n)=> (isNaN(n)?"â€”":`${(n*100).toFixed(0)}%`);
const preload=(srcs=[])=>srcs.forEach(s=>{const i=new Image();i.src=s});

/************** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆç´¯ç©æˆç¸¾ï¼‰ **************/
const STORAGE_KEY='gh_quiz_stats_v2_json';
function loadStats(){const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return{total:{correct:0,trials:0},perItem:{}};try{return JSON.parse(raw)}catch{return{total:{correct:0,trials:0},perItem:{}}}}
function saveStats(s){localStorage.setItem(STORAGE_KEY,JSON.stringify(s))}
function bump(s,id,isCorrect){s.total.trials+=1;if(isCorrect)s.total.correct+=1;if(!s.perItem[id])s.perItem[id]={correct:0,trials:0};s.perItem[id].trials+=1;if(isCorrect)s.perItem[id].correct+=1;saveStats(s)}

/************** çŠ¶æ…‹ **************/
let allQuestions=[]; let deck=[]; let step=0; let locked=false; let session={correct:0,trials:0}; let stats=loadStats();

/************** DOM **************/
const progressPill=document.getElementById('progressPill');
const topicPill=document.getElementById('topicPill');
const diffPill=document.getElementById('diffPill');
const qTitle=document.getElementById('qTitle');
const qImg=document.getElementById('qImg');
const choicesBox=document.getElementById('choices');
const explainBox=document.getElementById('explain');
const nextBtn=document.getElementById('nextBtn');
const skipBtn=document.getElementById('skipBtn');
const sessionAcc=document.getElementById('sessionAcc');
const sessionBar=document.getElementById('sessionBar');
const globalAcc=document.getElementById('globalAcc');
const globalBar=document.getElementById('globalBar');
const perItemTbody=document.querySelector('#perItem tbody');

/************** ç”»é¢æ›´æ–° **************/
function updateKPI(){
  const sAcc=session.trials?session.correct/session.trials:NaN;
  const gAcc=stats.total.trials?stats.total.correct/stats.total.trials:NaN;
  sessionAcc.textContent=pctTxt(sAcc); globalAcc.textContent=pctTxt(gAcc);
  sessionBar.style.width=`${clamp((sAcc||0),0,1)*100}%`;
  globalBar.style.width =`${clamp((gAcc||0),0,1)*100}%`;
  perItemTbody.innerHTML='';
  allQuestions.forEach(q=>{
    const r=stats.perItem[q.id]||{correct:0,trials:0};
    const acc=r.trials?(r.correct/r.trials):NaN;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${q.id}</td><td>${r.correct} / ${r.trials}</td><td>${r.trials?`<span class="mini-pill">${(acc*100).toFixed(0)}%</span>`:'â€”'}</td>`;
    perItemTbody.appendChild(tr);
  })
}

function render(){
  updateKPI();
  const q=deck[step];
  if(!q){
    qTitle.textContent='âœ… çµ‚äº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ã€‚';
    qImg.style.display='none'; choicesBox.innerHTML='';
    explainBox.textContent=`ä»Šå›ã®æˆç¸¾ï¼š${session.correct} / ${session.trials}ï¼ˆ${pctTxt(session.correct/session.trials)}ï¼‰`;
    document.getElementById('apps').style.display='none'; nextBtn.disabled=true; skipBtn.disabled=true;
    progressPill.textContent='å®Œäº†'; topicPill.textContent=`å…¨ ${deck.length} å•`; diffPill.textContent='Lv â€”';
    return;
  }
  progressPill.textContent=`Q ${step+1} / ${deck.length}`;
  topicPill.textContent=q.id; diffPill.textContent=`Lv ${q.level||'-'}`;
  qTitle.textContent=q.title;
  // å‡ºé¡Œæ™‚ã¯ãƒ’ãƒ³ãƒˆå›é¿ã®ãŸã‚éè¡¨ç¤º
  qImg.style.display='none'; qImg.src=q.img||'';

  // é¸æŠè‚¢ã¯æ¯å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  const randomized=shuffle(q.choices);
  choicesBox.innerHTML=''; explainBox.textContent=''; document.getElementById('apps').style.display='none'; document.getElementById('appsList').innerHTML=''; nextBtn.disabled=true; locked=false;
  randomized.forEach((text,idx)=>{
    const btn=document.createElement('button');
    btn.className='choice'; btn.type='button'; btn.textContent=text; btn.dataset.index=idx+1;
    btn.addEventListener('click',()=>onAnswer(q,text,btn));
    choicesBox.appendChild(btn);
  });
}

function onAnswer(q,selectedText,node){
  if(locked) return; locked=true;
  const isCorrect=(selectedText===q.correct);
  session.trials+=1; if(isCorrect) session.correct+=1; bump(stats,q.id,isCorrect);
  [...document.querySelectorAll('.choice')].forEach(n=>{ if(n.textContent===q.correct) n.classList.add('correct'); if(n===node && !isCorrect) n.classList.add('wrong'); n.disabled=true; });
  explainBox.innerHTML=(isCorrect?'âœ… æ­£è§£ï¼':`âŒ ä¸æ­£è§£ã€‚æ­£è§£ï¼šã€Œ${q.correct}ã€`)+"\n"+(q.explain||'');

  // å›ç­”å¾Œã«å•é¡Œç”»åƒï¼ˆassetsï¼‰ã‚’è¡¨ç¤º
  if(q.img){ qImg.style.display='block'; }

  // ä½¿ã„ã©ã“ã‚ï¼ˆæ­£è§£æ™‚ã®ã¿è¡¨ç¤ºã®ã¾ã¾ â†’ ä»•æ§˜ã‚’å¤‰ãˆã‚‹å ´åˆã¯ isCorrect æ¡ä»¶ã‚’å¤–ã™ï¼‰
  if(isCorrect && Array.isArray(q.apps) && q.apps.length){
    const appsBox=document.getElementById('apps');
    const appsList=document.getElementById('appsList');
    appsList.innerHTML='';
    q.apps.forEach(a=>{ const row=document.createElement('div'); row.className='apps-item'; const im=document.createElement('img'); im.src=a.img; im.alt=`${q.id} usecase`; const p=document.createElement('p'); p.textContent=a.text||''; row.appendChild(im); row.appendChild(p); appsList.appendChild(row); });
    appsBox.style.display='block';
  }
  nextBtn.disabled=false; updateKPI();
}

/************** ãƒ‡ãƒƒã‚­æ§‹ç¯‰ **************/
function buildDeck(){
  const count=10; // ã‚·ãƒ³ãƒ—ãƒ«é‹ç”¨ï¼šå¸¸ã«10å•ï¼ˆå¿…è¦ãªã‚‰UIã§èª¿æ•´å¯ï¼‰
  let pool=allQuestions.slice();
  preload(pool.map(p=>p.img).concat(pool.flatMap(p=> (p.apps||[]).map(a=>a.img) )));
  deck=pool.slice(0,count); step=0; session={correct:0,trials:0}; nextBtn.disabled=true; skipBtn.disabled=false; render();
}

/************** æ“ä½œç³» **************/
nextBtn.addEventListener('click',()=>{ step+=1; render(); });
skipBtn.addEventListener('click',()=>{ const q=deck[step]; session.trials+=1; bump(stats,q.id,false); step+=1; render(); });
document.getElementById('resetSession').addEventListener('click',()=>{ session={correct:0,trials:0}; updateKPI(); });
document.getElementById('resetGlobal').addEventListener('click',()=>{ stats={ total:{correct:0,trials:0}, perItem:{} }; saveStats(stats); updateKPI(); });
window.addEventListener('keydown',(ev)=>{
  const k=ev.key.toLowerCase();
  if(k>='1' && k<='9'){
    const idx=parseInt(k,10); const btn=document.querySelector(`.choice[data-index="${idx}"]`); if(btn) btn.click();
  } else if(k==='n'){ if(!nextBtn.disabled) nextBtn.click(); }
  else if(k==='s'){ skipBtn.click(); }
  else if(k==='r'){ document.getElementById('resetSession').click(); }
});

/************** JSON èª­ã¿è¾¼ã¿ **************/
async function loadQuestions(){
  try{
    const res=await fetch('questions.json?v=20251110', {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    allQuestions=await res.json();
    buildDeck();
  }catch(e){
    qTitle.textContent='âŒ questions.json ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼š'+e.message+"\nï¼ˆGitHub Pages ã¾ãŸã¯ localhost ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ï¼‰";
  }
}

loadQuestions();
</script>
</body>
</html>
